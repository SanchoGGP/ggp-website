<html>
  <head>
    <title>GGP.org - View</title>
    <meta name="description" content="General game playing is about playing games that you've never seen before. Watch intelligent computers play games against each other here!" />  
    <link rel="shortcut icon" href="http://www.ggp.org/favicon.ico">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:bold">
    <link rel="stylesheet" type="text/css" href="/viewer/bellerophon.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/Analytics.js'></script>
  </head>
  <body>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/ResourceLoader.js'></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/UserInterface.js'></script>
    <script type="text/javascript" src="/viewer/bellerophonHeader.js"></script>
  
    <div id='header'></div>
    <br>
    <center>
      <div id='playerList'></div>
    </center>

    <script type='text/javascript'>
      generateHeader(document.getElementById('header'));

      function renderPlayerListEntry(aPlayer, nPlayer) {
        var theHTML = '';
        if (nPlayer % 2 == 0) {
          theHTML += "<tr bgcolor=#F5F5F5>";
        } else {          
          theHTML += "<tr bgcolor=#E0E0E0>";
        }
        
        function renderCell(x) {
          if (x) {
            return '<td class="padded">' + x + '</td>';
          } else {
            return '<td></td>';
          }
        }
        
        pingStatusIcon = function(aPlayer) {
          var z = aPlayer.pingStatus;
          if (!aPlayer.isEnabled) {
            return '<img src="/viewer/images/presence/StatusGrey.png" title="Player is inactive."></img>';
          }
          if (z == null || z == "unknown") {
            return '<img src="/viewer/images/presence/StatusGrey.png" title="Player status is unknown."></img>';
          }
          if (z == "available") return '<img src="/viewer/images/presence/StatusGreen.png" title="Player is listed as active, and is currently ready for new matches."></img>';          
          if (z == "waiting") return '<img src="/viewer/images/presence/StatusWhite.png" title="Player was just activated: waiting to get its status..."></img>';
          if (z == "error") return '<img src="/viewer/images/presence/StatusError.png" title="Player is listed as active, but is being unresponsive, so its current status is unknown."></img>';          
          if (z == "busy") return '<img src="/viewer/images/presence/StatusOrange.png" title="Player is listed as active, and is currently busy playing a match."></img>';          
          return '<img src="/viewer/images/presence/StatusError.png" title="Player is listed as active, but its current status is unrecognizable: ' + z + '."></img>';
        }
        
        theHTML += renderCell(pingStatusIcon(aPlayer));
        theHTML += renderCell('<a href="/view/' + window.location.pathname.split("/")[2] + '/players/' + aPlayer.name + '">' + aPlayer.name + '</a>');
        theHTML += renderCell(aPlayer.visibleEmail);
        theHTML += renderCell(("theURL" in aPlayer) ? "Yours!" : null);
        theHTML += "<td width=10px></td>";

        theHTML += "</tr>";
        return theHTML;
      }
      
      // Returns a positive number if "aPlayer" should appear in the player
      // listing after "bPlayer".
      function playerComesAfter(aPlayer, bPlayer) {
        if (("theURL" in aPlayer) && !("theURL" in bPlayer)) return -1;
        if (!("theURL" in aPlayer) && ("theURL" in bPlayer)) return 1;      
        if (aPlayer.isEnabled && !bPlayer.isEnabled) return -1;
        if (!aPlayer.isEnabled && bPlayer.isEnabled) return 1;
        if (aPlayer.pingStatus && !bPlayer.pingStatus) return -1;
        if (!aPlayer.pingStatus && bPlayer.pingStatus) return 1;        
        if (aPlayer.name > bPlayer.name) return 1;
        if (aPlayer.name < bPlayer.name) return -1;
        return 0;
      }
      
      function drawPlayerList() {
        var observedPlayers = ResourceLoader.load_json('//database.ggp.org/statistics/' + getHostHashedPK() + '/overall').observedPlayers;

        var thePlayers = {};        
        var theHost = window.location.pathname.split("/")[2];
        if (theHost == "apollo" || theHost == "all") {
          thePlayers = ResourceLoader.load_json('//apollo.ggp.org/data/players/');
        }
        for (var i = 0; i < observedPlayers.length; i++) {
          if (!(observedPlayers[i] in thePlayers)) {
            thePlayers[observedPlayers[i]] = {"name":observedPlayers[i], "isEnabled":true, "pingStatus":null};
          }
        }
        
        var thePlayersList = [];
        for (var theName in thePlayers) {
          thePlayersList.push(thePlayers[theName]);
        }
        thePlayersList.sort(playerComesAfter);

        var playerListHTML = '<center><table class="matchlist" cellpadding="5px">';
        playerListHTML += '<tr bgcolor=#E0E0E0><th height=30px colspan=5>Player List</th></tr>';
        for (var i = 0; i < thePlayersList.length; i++) {
          playerListHTML += renderPlayerListEntry(thePlayersList[i], i);
        }
        playerListHTML += '</table></center>';
        document.getElementById('playerList').innerHTML = playerListHTML;   
      }
      
      drawPlayerList();
    </script>
  </body>  
</html>