<html>
  <head>
    <title>GGP.org - View</title>
    <meta name="description" content="General game playing is about playing games that you've never seen before. Watch intelligent computers play games against each other here!" />  
    <link rel="shortcut icon" href="http://www.ggp.org/favicon.ico">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:bold">
    <link rel="stylesheet" type="text/css" href="/viewer/bellerophon.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/Analytics.js'></script>
  </head>
  <body>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/ResourceLoader.js'></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/UserInterface.js'></script>
    <script type="text/javascript" src="/viewer/bellerophonHeader.js"></script>
  
    <div id='header'></div>
    <br>
    <center>
      <div id='playerList'></div>
    </center>

    <script type='text/javascript'>
      generateHeader(document.getElementById('header'));

      function renderPlayerListEntry(aPlayer, nPlayer, statsJSON) {
        var theHTML = '';
        if (nPlayer % 2 == 0) {
          theHTML += "<tr bgcolor=#F5F5F5>";
        } else {          
          theHTML += "<tr bgcolor=#E0E0E0>";
        }
        
        function renderCell(x, padded) {
          if (x) {
            if (padded) {
              return '<td class="padded">' + x + '</td>';
            } else {
              return '<td>' + x + '</td>';
            }
          } else {
            return '<td></td>';
          }
        }
        function renderPaddedCell(x) { return renderCell(x, true); }
        function renderRawCell(x) { return renderCell(x, false); }
        
        var pingStatusIcon = function(aPlayer) {          
          if (!aPlayer.isEnabled) {
            return '<img src="/viewer/images/presence/StatusGrey.png" title="Player is inactive."></img>';
          }
          var z = aPlayer.pingStatus;
          if (z == null) return '<img src="/viewer/images/presence/StatusGrey.png" title="Player status is unknown."></img>';
          z = z.toLowerCase();
          if (z == "unknown") return '<img src="/viewer/images/presence/StatusGrey.png" title="Player status is unknown."></img>';
          if (z == "available") return '<img src="/viewer/images/presence/StatusGreen.png" title="Player is listed as active, and is currently ready for new matches."></img>';          
          if (z == "waiting") return '<img src="/viewer/images/presence/StatusWhite.png" title="Player was just activated: waiting to get its status..."></img>';
          if (z == "error") return '<img src="/viewer/images/presence/StatusError.png" title="Player is listed as active, but is being unresponsive, so its current status is unknown."></img>';          
          if (z == "busy") return '<img src="/viewer/images/presence/StatusOrange.png" title="Player is listed as active, and is currently busy playing a match."></img>';
          return '<img src="/viewer/images/presence/StatusError.png" title="Player is listed as active, but its current status is unrecognizable: ' + z.replace(/\"/g,"'") + '."></img>';
        }
        
        var ownerInfo = function (aPlayer) {
          //var theHTML = "<center><table><tr>";
          var theHTML = "<td style='padding-left: 10; padding-right: 2'>";
          if ("visibleEmail" in aPlayer && aPlayer.visibleEmail && aPlayer.visibleEmail.length > 0) {          
            theHTML += '<a rel="nofollow" href="mailto:' + aPlayer.visibleEmail + '"><img width=20 src="/viewer/images/glyphicons/glyphicons_010_envelope.png" title="Contact email: ' + aPlayer.visibleEmail + '"></img></a>';
          }
          theHTML += "</td><td style='padding-left: 2; padding-right: 10'>";
          if ("visibleWebsite" in aPlayer && aPlayer.visibleWebsite && aPlayer.visibleWebsite.length > 0) {
            theHTML += '<a rel="nofollow" href="' + aPlayer.visibleWebsite + '"><img width=20 src="/viewer/images/glyphicons/glyphicons_020_home.png" title="Contact website: ' + aPlayer.visibleWebsite + '"></img></a>';
          }
          theHTML += "</td>";          
          // TODO: Support XMPP contact information?
          //if ("visibleEmail" in aPlayer && aPlayer.visibleEmail && aPlayer.visibleEmail.length > 0) {
          //  theHTML += '<td><a href="xmpp:' + aPlayer.visibleEmail + '"><img src="/viewer/images/glyphicons/glyphicons_245_chat.png" title="' + aPlayer.visibleEmail + '"></img></a></td>';
          //}
          // TODO: Indicate ownership somehow.
          //if ("theURL" in aPlayer) {
          //  theHTML += '<td><a href="//tiltyard.ggp.org/players/' + aPlayer.name + '"><img src="/viewer/images/glyphicons/glyphicons_44_keys.png" title="You own this player! Click to configure."></img></a></td>';
          //}          
          //theHTML += "</tr></table></center>";
          return theHTML;          
        }
        
        var colorSwatchAndLabel = function (scaledValue, realValue) {
          if (scaledValue != null && realValue != null) {
            var theHTML = '';
            theHTML += '<table style="height: 25px;"><tr>';
            theHTML += '<td title="' + cleanFloat(realValue) + '" style="width: 25px; text-align: center; background-color: ' + generateAgonViewColor(scaledValue) + ';"></td>';
            theHTML += '<td> ' + cleanFloat(realValue) + '</td>';
            theHTML += '</tr></table>';
            return theHTML;
          }
        }
        
        theHTML += renderPaddedCell(pingStatusIcon(aPlayer));
        theHTML += renderPaddedCell('<a href="/view/' + window.location.pathname.split("/")[2] + '/players/' + aPlayer.name + '">' + trimTo(aPlayer.name,20) + '</a>');
        theHTML += ownerInfo(aPlayer);
        theHTML += renderPaddedCell(("theURL" in aPlayer) ? "Yours!" : null);
        
        theHTML += renderPaddedCell(aPlayer.totalMatches);
        theHTML += renderPaddedCell(cleanFloat(aPlayer.averageScore));
        theHTML += renderPaddedCell(cleanFloat(aPlayer.netScore));
        theHTML += renderPaddedCell(cleanFloat(aPlayer.eloRank));
        theHTML += renderPaddedCell(colorSwatchAndLabel(aPlayer.agonScaledSkill, aPlayer.agonSkill));        
        
        theHTML += "<td width=10px></td>";

        theHTML += "</tr>";
        return theHTML;
      }
      
      // Returns a positive number if "aPlayer" should appear in the player
      // listing after "bPlayer".
      function getPlayerComesAfter(mode) {
        if (mode == "mine") {
          return function(aPlayer, bPlayer) {
            if (("theURL" in aPlayer) && !("theURL" in bPlayer)) return -1;
            if (!("theURL" in aPlayer) && ("theURL" in bPlayer)) return 1;      
            if (aPlayer.isEnabled && !bPlayer.isEnabled) return -1;
            if (!aPlayer.isEnabled && bPlayer.isEnabled) return 1;
            if (aPlayer.pingStatus && !bPlayer.pingStatus) return -1;
            if (!aPlayer.pingStatus && bPlayer.pingStatus) return 1;
            if (aPlayer.name > bPlayer.name) return 1;
            if (aPlayer.name < bPlayer.name) return -1;
            return 0;
          }
        } else if (mode == "bestActive") {
          return function(aPlayer, bPlayer) {
            var isThirtyDayActive = function (x) { return (new Date() - x.lastPlayed) < 2592000000; }; 
            if (aPlayer.agonSkill && !bPlayer.agonSkill) return -1;
            if (!aPlayer.agonSkill && bPlayer.agonSkill) return 1;
            if (!aPlayer.agonSkill && !bPlayer.agonSkill) return 0;
            if (isThirtyDayActive(aPlayer) && !isThirtyDayActive(bPlayer)) return -1;
            if (!isThirtyDayActive(aPlayer) && isThirtyDayActive(bPlayer)) return 1;
            return bPlayer.agonSkill - aPlayer.agonSkill;
          }        
        } else {
          return function(aPlayer, bPlayer) {
            if (aPlayer[mode] && !bPlayer[mode]) return -1;
            if (!aPlayer[mode] && bPlayer[mode]) return 1;
            if (!aPlayer[mode] && !bPlayer[mode]) return 0;
            return bPlayer[mode] - aPlayer[mode];
          }        
        }         
      }
      
      var statsJSON = ResourceLoader.load_json('//database.ggp.org/statistics/' + getHostHashedPK() + '/overall');
      
      function getPlayersList() {        
        var observedPlayers = statsJSON.observedPlayers;

        var thePlayers = {};
        var theHost = window.location.pathname.split("/")[2];
        if (theHost == "tiltyard" || theHost == "all") {
          thePlayers = ResourceLoader.load_json('//tiltyard.ggp.org/data/players/');
        }
        for (var i = 0; i < observedPlayers.length; i++) {
          if (!(observedPlayers[i] in thePlayers)) {
            thePlayers[observedPlayers[i]] = {"name":observedPlayers[i], "isEnabled":true, "pingStatus":null};
          }
        }

        var thePlayersList = [];        
        getOptionalMapValue = function(k,s,m) { return (m in s && k in s[m]) ? s[m][k] : null; }
        for (var theName in thePlayers) {
          // First, attach statistics data.
          var averageScoreData = getOptionalMapValue(theName, statsJSON, "averageScore");
          thePlayers[theName].averageScore = averageScoreData ? averageScoreData[0] : null;
          thePlayers[theName].totalMatches = averageScoreData ? averageScoreData[1] : null;
          thePlayers[theName].agonSkill = getOptionalMapValue(theName, statsJSON, "agonSkill");
          thePlayers[theName].agonScaledSkill = getOptionalMapValue(theName, statsJSON, "agonScaledSkill");
          thePlayers[theName].netScore = getOptionalMapValue(theName, statsJSON, "netScore");
          thePlayers[theName].eloRank = getOptionalMapValue(theName, statsJSON, "eloRank");
          thePlayers[theName].lastPlayed = getOptionalMapValue(theName, statsJSON, "lastPlayed");
          // Then, add to the list of players.
          thePlayersList.push(thePlayers[theName]);
        }
        
        return thePlayersList;
      }
      
      function drawPlayersList(thePlayersList) {
        var playerListHTML = '<center><table class="matchlist" cellpadding="5px">';
        playerListHTML += '<tr bgcolor=#E0E0E0><th></th>';
        playerListHTML += '<th style="text-align: left;" height=30px><a class="darklink" href="#" onclick="redrawPlayersList(\'mine\');"><u>Player Name</u></a></th>';
        playerListHTML += '<th colspan=2><center>Contact</center></th><th></th>';
        playerListHTML += '<th><a class="darklink" href="#" onclick="redrawPlayersList(\'totalMatches\');"><u>Matches</u></a></th>';
        playerListHTML += '<th><a class="darklink" href="#" onclick="redrawPlayersList(\'averageScore\');"><u>Avg Score</u></a></th>';
        playerListHTML += '<th><a class="darklink" href="#" onclick="redrawPlayersList(\'netScore\');" title="NetScore increases by 1 when you get 100 points in a match, decreases by 1 when you get 0 points in a match, and does not change when you get 50 points in a match."><u>NetScore</u></a></th>';
        playerListHTML += '<th><a class="darklink" href="#" onclick="redrawPlayersList(\'eloRank\');" title="EloRank is the standard Chess ranking system. It ignores puzzle games and cooperative games."><u>EloRank</u></a></th>';
        playerListHTML += '<th><a class="darklink" href="#" onclick="redrawPlayersList(\'agonSkill\');" title="AgonSkill is a variant of Chess ranking designed for General Game Playing, in which you play against the game in addition to playing against your opponent. It counts puzzles. (Better description forthcoming)"><u>Agon Skill</u></a></th><th></th></tr>';
        for (var i = 0; i < thePlayersList.length; i++) {
          playerListHTML += renderPlayerListEntry(thePlayersList[i], i, statsJSON);
        }
        playerListHTML += '</table></center>';
        document.getElementById('playerList').innerHTML = playerListHTML;   
      }
      
      var thePlayersList = getPlayersList();
      thePlayersList.sort(getPlayerComesAfter("bestActive"));
      drawPlayersList(thePlayersList);
      
      function redrawPlayersList(mode) {
        thePlayersList.sort(getPlayerComesAfter(mode));
        drawPlayersList(thePlayersList);        
      }
    </script>
  </body>  
</html>
